<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Video Downloader Kawaii</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- ffmpeg.js untuk merge client-side -->
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.10.1/dist/ffmpeg.min.js"></script>
  <style>
    /* ————— Semua style kamu tetap sama seperti sebelumnya ————— */
    body { margin: 0; font-family: 'Poppins', sans-serif; /* … */ }
    .banner { /* … */ }
    .container { /* … */ }
    .res-button { /* … */ }
    /* dsb. */
  </style>
</head>
<body>
  <div class="banner">SELAMAT DATANG</div>
  <div class="container">
    <div class="image-wrapper">
      <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh1pwO52hgZ0o0ZPrJg2CL3NcrD0tgYCMQuc5JIhBrNMiASdNSFnmHCVfr6YeaJsRxfQx-Frn-CcZYqz2gMwh_T-4Gohn7MFrJrLrgstuwHRBNgBtT-bkHRGswLHD3KfDAkZt_uHQoXEoeSXErvkbx1zRafsZtJ8IcBVVhk81jKuAVsX2WyP0HGzHbbv7A/s736/cb74b4cf255d77188a95fd04d1e76d7c.jpg" alt="Gambar Kawaii">
    </div>
    <h1>Download Video</h1>
    <input id="url" type="text" placeholder="Tempelkan link video di sini…" /><br>
    <button onclick="downloadVideo()">Mulai Download</button>
    <div id="loading"><div class="spinner"></div><p>Sedang diproses…</p></div>
    <div id="resolution-selector">
      <h3>Pilih Kualitas Video:</h3>
      <div id="res-buttons"></div>
    </div>
    <div id="error-message">Maaf, video+audio tidak tersedia.</div>
    <p class="note">Support YouTube, TikTok, Instagram, Facebook &amp; banyak lagi.</p>
  </div>

  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    async function downloadVideo() {
      const url = document.getElementById("url").value.trim();
      if (!url) return alert("Masukkan URL video dulu yaa!");

      // Reset UI
      document.getElementById("loading").style.display = "block";
      document.getElementById("resolution-selector").style.display = "none";
      document.getElementById("error-message").style.display = "none";
      document.getElementById("res-buttons").innerHTML = "";

      // Panggil API
      let resp = await fetch(
        "https://social-media-video-downloader.p.rapidapi.com/smvd/get/all?url=" +
          encodeURIComponent(url), {
          method: "GET",
          headers: {
            "X-RapidAPI-Key": "837393c934msh8747bcb37b91d8ep1ba687jsn4ed59f6c1497",
            "X-RapidAPI-Host": "social-media-video-downloader.p.rapidapi.com"
          }
      });
      const data = await resp.json();
      document.getElementById("loading").style.display = "none";

      if (!data.links || !data.links.length) {
        return document.getElementById("error-message").style.display = "block";
      }

      // Pisahkan stream video dan audio
      const streams = {
        audio: data.links.find(l =>
          l.quality?.toLowerCase().includes("audio") &&
          /audio/i.test(l.link)
        )?.link,
      };
      // Ambil video-only untuk resolusi yang kita inginkan
      ["1080p","720p","360p"].forEach(res => {
        const vid = data.links.find(l =>
          l.quality?.includes(res) &&
          !l.quality.toLowerCase().includes("audio") &&
          !l.quality.toLowerCase().includes("only_video")
        );
        if (vid && streams.audio) {
          addButton(`MP4 ${res} (Video + Audio)`, vid.link, streams.audio);
        }
      });

      if (document.getElementById("res-buttons").children.length) {
        document.getElementById("resolution-selector").style.display = "block";
      } else {
        document.getElementById("error-message").style.display = "block";
      }
    }

    // Buat tombol yang langsung merge & download
    function addButton(label, videoUrl, audioUrl) {
      const btn = document.createElement("button");
      btn.className = "res-button";
      btn.innerText = label;
      btn.onclick = async () => {
        btn.disabled = true;
        btn.innerText = "Menggabungkan…";
        if (!ffmpeg.isLoaded()) await ffmpeg.load();
        const [v, a] = await Promise.all([fetchFile(videoUrl), fetchFile(audioUrl)]);
        ffmpeg.FS("writeFile", "video.mp4", v);
        ffmpeg.FS("writeFile", "audio.m4a", a);
        await ffmpeg.run("-i", "video.mp4", "-i", "audio.m4a", "-c", "copy", "out.mp4");
        const data = ffmpeg.FS("readFile", "out.mp4");
        const blob = new Blob([data.buffer], { type: "video/mp4" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `video_${label.replace(/[^0-9p]/g,"")}.mp4`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        btn.disabled = false;
        btn.innerText = label;
      };
      document.getElementById("res-buttons").appendChild(btn);
    }
  </script>
</body>
</html>
